# Redis configuration for stream data persistence
# Optimized for reliability and performance

# === PERSISTENCE CONFIGURATION ===

# Enable AOF (Append Only File) for maximum durability
appendonly yes
appendfilename "appendonly.aof"

# AOF rewrite configuration
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# AOF fsync policy - ensure data is written to disk
# Options: always, everysec, no
appendfsync everysec

# Prevent data loss during AOF rewrite
no-appendfsync-on-rewrite no

# === RDB SNAPSHOTS ===
# Keep RDB snapshots as backup alongside AOF

# Save snapshots:
# - After 3600 seconds if at least 1 key changed
# - After 300 seconds if at least 100 keys changed  
# - After 60 seconds if at least 10000 keys changed
save 3600 1 300 100 60 10000

# RDB file settings
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb

# === MEMORY MANAGEMENT ===

# Set max memory (adjust based on your needs)
# maxmemory 2gb

# Eviction policy - important for streams
# Use allkeys-lru to keep most recent data
maxmemory-policy allkeys-lru

# === STREAM-SPECIFIC OPTIMIZATIONS ===

# Increase stream node max bytes for better performance
stream-node-max-bytes 4096

# Increase stream node max entries
stream-node-max-entries 100

# === GENERAL OPTIMIZATIONS ===

# TCP settings
tcp-keepalive 300
tcp-backlog 511

# Client settings
timeout 0
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Logging
loglevel notice
logfile ""

# Database settings
databases 16

# === SECURITY ===
# Disable dangerous commands in production
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command DEBUG ""

# === SLOW LOG ===
slowlog-log-slower-than 10000
slowlog-max-len 128

# === LATENCY MONITORING ===
latency-monitor-threshold 100